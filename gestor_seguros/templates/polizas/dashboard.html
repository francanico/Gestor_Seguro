{% extends "base.html" %}
{% load humanize %}

{% block title %}Dashboard de Agencia{% endblock %}

{% block content %}
<div class="page-header">
    <h2><i class="fas fa-tachometer-alt"></i> Dashboard de P贸lizas</h2>
</div>

<!-- Fila de Indicadores Clave (KPIs) -->
<div class="row">
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card kpi-card bg-primary text-white h-100">
            <div class="card-body">
                <div><div class="kpi-value">{{ total_clientes }}</div><div class="kpi-label">Total Clientes</div></div>
                <i class="fas fa-users kpi-icon"></i>
            </div>
            <div class="card-footer"><a href="{% url 'clientes:lista_clientes' %}" class="small stretched-link">Ver Detalles <i class="fas fa-angle-right"></i></a></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card kpi-card bg-success text-white h-100">
            <div class="card-body">
                <div><div class="kpi-value">{{ total_polizas_vigentes }}</div><div class="kpi-label">P贸lizas Vigentes</div></div>
                <i class="fas fa-file-invoice kpi-icon"></i>
            </div>
            <div class="card-footer"><a href="{% url 'polizas:lista_polizas' %}" class="small stretched-link">Ver Detalles <i class="fas fa-angle-right"></i></a></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card kpi-card bg-warning text-dark h-100">
            <div class="card-body">
                <div><div class="kpi-value">{{ polizas_a_vencer_30.count }}</div><div class="kpi-label">Vencen en 30 d铆as</div></div>
                <i class="fas fa-exclamation-triangle kpi-icon"></i>
            </div>
            <div class="card-footer"><a href="#vencimientos" class="small stretched-link">Ver Detalles <i class="fas fa-angle-right"></i></a></div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6 mb-4">
        <div class="card kpi-card bg-danger text-white h-100">
            <div class="card-body">
                <div><div class="kpi-value">{{ polizas_vencidas.count }}</div><div class="kpi-label">P贸lizas Vencidas</div></div>
                <i class="fas fa-calendar-times kpi-icon"></i>
            </div>
            <div class="card-footer"><a href="#vencimientos" class="small stretched-link">Ver Detalles <i class="fas fa-angle-right"></i></a></div>
        </div>
    </div>
</div>

<!-- Contenido Principal del Dashboard -->
<div class="row">
    <!-- COLUMNA IZQUIERDA -->
    <div class="col-lg-8">
        
        {% if polizas_en_tramite %}
        <div class="card border-info mb-4">
            <div class="card-header bg-info text-dark"><i class="fas fa-hourglass-start"></i> P贸lizas en Tr谩mite / Renovaciones Pendientes ({{ polizas_en_tramite|length }})</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th># P贸liza</th>
                                <th>Cliente</th>
                                <th>Inicio Vigencia</th>
                                <th class="text-center">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for poliza in polizas_en_tramite %}
                            <tr>
                                <td><a href="{{ poliza.get_absolute_url }}">{{ poliza.numero_poliza }}</a></td>
                                <td>{{ poliza.cliente.nombre_completo }}</td>
                                <td>{{ poliza.fecha_inicio_vigencia|date:"d/m/Y" }}</td>
                                <td class="text-center">
                                    <a href="{% url 'polizas:editar_poliza' poliza.pk %}" class="btn btn-sm btn-warning" title="Gestionar y Activar"><i class="fas fa-edit"></i> Gestionar</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        {% endif %}

        {% if cobros_vencidos %}
        <div class="card border-danger mb-4">
    <div class="card-header bg-danger text-white">隆Atenci贸n! Cobros de Cuotas Vencidos ({{ cobros_vencidos|length }})</div>
    <div class="card-body p-0">
        {% include "polizas/_proximos_cobros_tabla.html" with lista_de_cobros=cobros_vencidos %}
    </div>
</div>
        {% endif %}

        <div class="card mb-4" id="vencimientos">
            <div class="card-header"><i class="fas fa-bell"></i> P贸lizas por Vencer en los Pr贸ximos 30 D铆as ({{ polizas_a_vencer_30.count }})</div>
            <div class="card-body p-0">{% include "polizas/_tabla_polizas_recordatorio.html" with polizas=polizas_a_vencer_30 %}</div>
        </div>
        
        <div class="card">
    <div class="card-header">Pr贸ximos Cobros de Cuotas (en 30 d铆as) ({{ cobros_pendientes_30_dias|length }})</div>
    <div class="card-body p-0">
        {% include "polizas/_proximos_cobros_tabla.html" with lista_de_cobros=cobros_pendientes_30_dias %}
    </div>
</div>

    </div>

    <!-- COLUMNA DERECHA -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header"><i class="fas fa-birthday-cake"></i> Cumplea帽os del Mes</div>
            <div class="card-body">{% include "polizas/_cumpleanos_lista.html" %}</div>
        </div>
        <div class="card">
            <div class="card-header"><i class="fas fa-hand-holding-usd"></i> Comisiones Pendientes</div>
            <div class="card-body">{% include "polizas/_comisiones_pendientes_lista.html" %}</div>
        </div>
    </div>
</div>

</div> <!-- Fin de la fila principal -->

<!-- Almacenar datos para notificaciones JS -->
<div id="notification-data" 
    data-cumpleaneros-hoy="{{ cumpleaneros_hoy_json }}"
    data-polizas-vencen-semana="{{ polizas_vencen_semana_json }}"
    style="display: none;">
</div>
{% endblock %}

{% block extra_js %}
<!-- Toastify.js -->
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const notificationData = document.getElementById('notification-data');
    
    // Notificaciones de Cumplea帽os
    try {
        const cumpleaneros = JSON.parse(notificationData.dataset.cumpleanerosHoy);
        if (cumpleaneros.length > 0) {
            let nombres = cumpleaneros.map(c => c.nombre).join(', ');
            Toastify({
                text: ` 隆Hoy es el cumplea帽os de ${nombres}! No olvides Felicitarlo.`,
                duration: 10000,
                close: true,
                gravity: "bottom",
                position: "right",
                backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
            }).showToast();
        }
    } catch (e) { console.error('Error parsing birthday data:', e); }

    // Notificaciones de P贸lizas por Vencer
    try {
        const polizasVencen = JSON.parse(notificationData.dataset.polizasVencenSemana);
        if (polizasVencen.length > 0) {
            let texto = ` Tienes ${polizasVencen.length} p贸liza(s) que vencen en los pr贸ximos 7 d铆as.`;
            Toastify({
                text: texto,
                destination: "{% url 'polizas:lista_polizas' %}",
                newWindow: true,
                duration: 15000,
                close: true,
                gravity: "bottom",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
            }).showToast();
        }
    } catch (e) { console.error('Error parsing policy data:', e); }
});
</script>
{% endblock %}