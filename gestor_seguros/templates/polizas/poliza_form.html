{% extends "base.html" %}
{% load static %}

{% block content %}
    <h2>{{ titulo_pagina }}</h2>
    <hr>
    
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <h3>Datos de la Póliza</h3>
        {{ form.as_p }}

        <hr>
        <h3>Asegurados en la Póliza</h3>
        
        {{ formset.management_form }}
        
        <div id="asegurado-form-list">
            {% for asegurado_form in formset %}
            <div class="asegurado-form">
                {{ asegurado_form.as_p }}
                {% if asegurado_form.instance.pk %}
                    <label for="{{ asegurado_form.DELETE.id_for_label }}">Eliminar:</label>
                    {{ asegurado_form.DELETE }}
                {% endif %}
                <hr>
            </div>
            {% endfor %}
        </div>
        
        <div id="empty-form" style="display:none;">
            <div class="asegurado-form">
                {{ formset.empty_form.as_p }}
                <hr>
            </div>
        </div>

        <button type="button" id="add-form-btn">Añadir Asegurado</button>
        <hr>

        <button type="submit">Guardar Cambios</button>
        <a href="{% if object %}{{ object.get_absolute_url }}{% else %}{% url 'polizas:lista_polizas' %}{% endif %}">Cancelar</a>
    </form>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const addButton = document.getElementById('add-form-btn');
    const container = document.getElementById('asegurado-form-list');
    const emptyForm = document.getElementById('empty-form').innerHTML;
    const totalFormsInput = document.getElementById('id_asegurados-TOTAL_FORMS');
    
    addButton.addEventListener('click', function() {
        const formNum = parseInt(totalFormsInput.value);
        const newForm = emptyForm.replace(/__prefix__/g, formNum);
        container.insertAdjacentHTML('beforeend', newForm);
        totalFormsInput.value = formNum + 1;
    });
});
</script>
{% endblock %}