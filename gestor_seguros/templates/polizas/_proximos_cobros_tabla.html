{% load humanize %}

{# La variable 'lista_de_cobros' será 'cobros_vencidos' o 'cobros_pendientes_30_dias' #}
{% with lista_de_cobros=cobros_pendientes_30_dias %}

{% if lista_de_cobros %}
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead>
                <tr>
                    <th>Vencimiento (Días)</th>
                    <th># Póliza</th>
                    <th>Cliente</th>
                    <th class="text-end">Monto Cuota</th>
                    <th class="text-center">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for poliza in lista_de_cobros %}
                {# Obtenemos la primera cuota pendiente de la póliza #}
                {% with primera_cuota=poliza.cuotas_pendientes_precargadas.0 %}
                {% if primera_cuota %}
                <tr class="{% if poliza.dias_para_proximo_cobro < 0 %}table-danger{% elif poliza.dias_para_proximo_cobro == 0 %}table-warning{% endif %}">
                    <td class="fw-bold">
                        {{ primera_cuota.fecha_vencimiento_cuota|date:"d/m/Y" }}
                        {% with dias=poliza.dias_para_proximo_cobro %}
                            {% if dias is not None %}
                                {% if dias < 0 %}
                                    <span class="badge bg-danger ms-1">Vencido hace {{ dias|slice:"1:" }} d.</span>
                                {% elif dias == 0 %}
                                    <span class="badge bg-warning text-dark ms-1">Hoy</span>
                                {% else %}
                                    <span class="badge bg-info text-dark ms-1">{{ dias }} día{{ dias|pluralize }}</span>
                                {% endif %}
                            {% endif %}
                        {% endwith %}
                    </td>
                    <td><a href="{{ poliza.get_absolute_url }}">{{ poliza.numero_poliza }}</a></td>
                    <td><a href="{{ poliza.cliente.get_absolute_url }}">{{ poliza.cliente.nombre_completo }}</a></td>
                    <td class="text-end">${{ primera_cuota.monto_cuota|intcomma }}</td>
                    <td class="text-center">
                        <div class="action-buttons btn-group" role="group">
                            <!-- Botón para Marcar como Pagada -->
                            <form action="{% url 'polizas:marcar_cuota_pagada' primera_cuota.pk %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success" title="Marcar esta cuota como Pagada">
                                    <i class="fas fa-check"></i>
                                </button>
                            </form>
                            <!-- Botón para Ver Detalles de la Póliza -->
                            <a href="{{ poliza.get_absolute_url }}" class="btn btn-info" title="Ver Detalles de Póliza">
                                <i class="fas fa-eye"></i>
                            </a>
                        </div>
                    </td>
                </tr>
                {% endif %}
                {% endwith %}
                {% endfor %}
            </tbody>
        </table>
    </div>
{% else %}
    <p class="text-muted p-3 mb-0">No hay cobros de cuotas en este rango.</p>
{% endif %}

{% endwith %}