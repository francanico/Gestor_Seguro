{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Detalle de Póliza: {{ poliza.numero_poliza }}{% endblock %}

{% block content %}

<!-- Cabecera de la Página con Acciones -->
<div class="page-header">
    <h2>
        <i class="fas fa-file-invoice-dollar"></i> Detalle de Póliza: {{ poliza.numero_poliza }}
        <span class="badge fs-6 ms-2 bg-success">{{ poliza.get_estado_poliza_display }}</span>
    </h2>
    <div>
        {% if poliza.estado_poliza not in "RENOVADA,CANCELADA" %}
            <a href="{% url 'polizas:renovar_poliza' poliza.pk %}" class="btn btn-success"><i class="fas fa-sync-alt"></i> Renovar</a>
        {% endif %}
        <a href="{% url 'polizas:editar_poliza' poliza.pk %}" class="btn btn-warning"><i class="fas fa-edit"></i> Editar</a>
        <a href="{% url 'polizas:lista_polizas' %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>
</div>

<!-- Fila Principal con 2 Columnas -->
<div class="row">
    <!-- Columna Izquierda: Información General -->
    <div class="col-lg-7">
        <div class="card mb-4">
            <div class="card-header">Información General</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Número de Póliza:</strong> {{ poliza.numero_poliza }}</p>
                        <p><strong>Cliente Contratante:</strong> <a href="{{ poliza.cliente.get_absolute_url }}">{{ poliza.cliente.nombre_completo }}</a></p>
                        <p><strong>Aseguradora:</strong> <a href="{{ poliza.aseguradora.get_absolute_url }}">{{ poliza.aseguradora.nombre }}</a></p>
                        <p><strong>Ramo:</strong> {{ poliza.ramo_tipo_seguro }}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Fecha Emisión:</strong> {{ poliza.fecha_emision|date:"d/m/Y" }}</p>
                        <p><strong>Inicio Vigencia:</strong> {{ poliza.fecha_inicio_vigencia|date:"d/m/Y" }}</p>
                        <p><strong>Fin Vigencia:</strong> {{ poliza.fecha_fin_vigencia|date:"d/m/Y" }}</p>
                    </div>
                </div>
                {% if poliza.descripcion_bien_asegurado %}
                    <hr><p><strong>Bien Asegurado:</strong> {{ poliza.descripcion_bien_asegurado }}</p>
                {% endif %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Asegurados Cubiertos</div>
            <div class="card-body">
                {% for asegurado in poliza.asegurados.all %}
                    <p><strong>{{ asegurado.get_parentesco_display }}:</strong> {{ asegurado.nombre_completo }}</p>
                {% empty %}
                    <p class="text-muted">No hay asegurados adicionales registrados.</p>
                {% endfor %}
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">Historial de Siniestros</div>
            <div class="card-body">
                <!-- ... (código de siniestros sin cambios) ... -->
            </div>
        </div>
    </div>

    <!-- Columna Derecha: Pagos y Comisiones -->
    <div class="col-lg-5">
        <div class="card mb-4">
            <div class="card-header">Valores y Comisiones</div>
            <div class="card-body">
                <p><strong>Prima Total Anual:</strong> ${{ poliza.prima_total_anual|floatformat:2|intcomma }}</p>
                <p><strong>Frecuencia de Pago:</strong> {{ poliza.get_frecuencia_pago_display }}</p>
                {% if poliza.valor_cuota %}<p><strong>Valor Cuota:</strong> ${{ poliza.valor_cuota|floatformat:2|intcomma }}</p>{% endif %}
                <hr>
                <p><strong>Monto Comisión:</strong> ${{ poliza.comision_monto|floatformat:2|intcomma }}</p>
                <p><strong>Comisión Cobrada:</strong> 
                    {% if poliza.comision_cobrada %}
                        <span class="text-success"><i class="fas fa-check-circle"></i> Sí</span>
                    {% else %}
                        <span class="text-danger"><i class="fas fa-times-circle"></i> No</span>
                    {% endif %}
                </p>
            </div>
        </div>

        <!-- ============================================== -->
        <!-- NUEVA SECCIÓN DE PLAN DE PAGOS                 -->
        <!-- ============================================== -->
        <div class="card-body p-0">
    <ul class="list-group list-group-flush">
        {% for cuota in poliza.cuotas.all %}
        <li class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <span class="fw-bold">{{ cuota.fecha_vencimiento_cuota|date:"d/m/Y" }}</span>
                <small class="d-block text-muted">${{ cuota.monto_cuota|floatformat:2|intcomma }}</small>
            </div>

            <!-- ============================================== -->
            <!-- LÓGICA CONDICIONAL PARA PAGAR/CANCELAR       -->
            <!-- ============================================== -->
            {% if cuota.estado == 'PENDIENTE' %}
                <form action="{% url 'polizas:marcar_cuota_pagada' cuota.pk %}" method="post" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-success" title="Marcar como Pagada">
                        <i class="fas fa-check"></i> Pagar
                    </button>
                </form>
            {% else %}
                <div>
                    <span class="badge bg-success me-2">
                        <i class="fas fa-check-circle"></i> Pagado el {{ cuota.fecha_de_pago_realizado|date:"d/m/Y" }}
                    </span>
                    <form action="{% url 'polizas:cancelar_pago_cuota' cuota.pk %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Revertir este pago">
                            <i class="fas fa-undo"></i>
                        </button>
                    </form>
                </div>
            {% endif %}
        </li>
        {% empty %}
        <li class="list-group-item text-muted">El plan de pagos no ha sido generado.</li>
        {% endfor %}
    </ul>
</div>
        <!-- ============================================== -->
        <!-- FIN SECCIÓN DE PLAN DE PAGOS                  -->
        <!-- ============================================== -->

    </div>

<!-- Sección de Documentos -->
{% if content_type %}
    {% include "_documentos_seccion.html" %}
{% endif %}

<hr>
<small class="text-muted">Registrada: {{ poliza.fecha_creacion|date:"d/m/Y H:i" }} | Última actualización: {{ poliza.fecha_actualizacion|date:"d/m/Y H:i" }}</small>

{% endblock %}